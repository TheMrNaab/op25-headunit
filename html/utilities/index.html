<!--utilities/inde.html-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Systems Config Editor</title>
  <link href="../static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  
   <!-- Font Awesome Icons -->
   <link rel="stylesheet" href="../static/fa/css/all.min.css">
   <link href="backend.css?v=3" rel="stylesheet">
</head>
<body>
<div class="container my-4">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">RadioApp</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="system.html">System</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="talkgroups.html">Talkgroups</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="channels.html">Channels</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- Import Modal Trigger Button (kept in button group) -->
  <div class="main-container">
    <div class="alert alert-warning custom-alert" role="alert">
      <strong>Note:</strong> These settings are not yet editable. This webpage will be available in the future.
    </div>
    <h2 class="mt-4">System Configuration</h2>
    <p>
      This tool allows you to configure the overall system settings for the OP25 scanner platform. Only modify settings that you understand.
    </p>
    <form id="config-form">
      <h4><i class="fa fa-laptop me-2"></i>Local Settings</h4>
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">
            Display Sleep
            <i class="fas fa-info-circle txt-white text-muted ms-1" data-bs-toggle="popover" title="Display Timeout" data-bs-content="Specifies the amount of minutes your default display is on before sleeping."></i>
          </label>
          <input type="text"  class="form-control form-control-sm" id="display_sleep" >
        </div>
      </div>
      <h4><i class="fa fa-code me-2"></i>Hosts</h4>
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">
            API Host
            <i class="fas fa-info-circle txt-white text-muted ms-1" data-bs-toggle="popover" title="API Host" data-bs-content="Specifies the address of the backend API server your frontend should communicate with."></i>
          </label>
          <input type="text" data-field="api_host" data-section="hosts" disabled class="form-control form-control-sm" id="api_host" >
        </div>
        <div class="col-md-4">
          <label class="form-label">
            Default System File
            <i class="fas fa-info-circle txt-white text-muted ms-1" data-bs-toggle="popover" title="Default System File" data-bs-content="Path to the system definition file to load at startup."></i>
          </label>
          <input type="text" class="form-control-sm form-control" disabled id="default_system_file" >
        </div>
        <div class="col-md-4">
          <label class="form-label">
            OP25 Directory
            <i class="fas fa-info-circle txt-white text-muted ms-1" disabled data-bs-toggle="popover" title="OP25 Directory" data-bs-content="Filesystem path to the OP25 application's root directory."></i>
          </label>
          <input type="text" class="form-control-sm form-control" disabled id="rx_script" >
        </div>
    </div>

    <!-- OP25 Settings -->
        <h4 class="mt-4 mb-4"><i class="fa fa-code me-2"></i>OP25 Settings</h4>
          <div class="row mb-3">
            <label class="form-label mb-2">
              Sample Rate
              <i class="fas fa-info-circle txt-white text-muted ms-1" data-bs-toggle="popover" title="Sample Rate" data-bs-content="The number of samples per second used by the SDR. Typical values are 2M or 2.4M."></i>
              <input data-field="sample_rate" data-section="op25" type="text" id="sample_rate" class="form-control form-control-sm mt-2" >
            </label>
            <div class="col-md-4">
              <label class="form-label">
                Frequency Correction
                <i class="fas fa-info-circle txt-white ms-1" data-bs-toggle="popover" title="Frequency Correction" data-bs-content="PPM offset to correct drift in your SDR hardware. Use if transmissions are slightly off-tune."></i>
              </label>
              <input type="number" data-field="frequency_correction" data-section="op25" id="frequency_correction" class="form-control form-control-sm" >
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">
                RX Script
                <i class="fas fa-info-circle txt-white text-muted ms-1" data-bs-toggle="popover" title="RX Script" data-bs-content="Path to the Python script that launches OP25 receiver (rx.py)."></i>
              </label>
              <input type="text" data-field="rx_script" data-section="op25" class="form-control-sm form-control" id="rx_script" >
            </div>
              <div class="col-md-6">
                <label class="form-label">
                  Python Path
                  <i class="fas fa-info-circle txt-white ms-1" data-bs-toggle="popover" title="Python Path" data-bs-content="Paths required for OP25 runtime, typically include tx and build directories."></i>
                </label>
                <input type="text" disabled class="form-control-sm form-control" id="pythonpath" >
              </div>
            </div>
        <!-- UDP SETTINGS -->
        <h4 class="mt-4 mb-4"><i class="fa fa-code me-2"></i>Audio</h4>
        <div class="row mb-3">
            <div class="col-md-6 ">
              <!-- MAKE AUTO ENABLE/DISABLE DATA-REL CONTROL -->
              <input data-field="udp_output" data-section="op25" type="checkbox" data-relative="udp_output_port" id="udp_output" class="form-check-input" >
              <label class="form-label">
                UDP Output
                <i class="fas txt-white fa-info-circle text-muted ms-1" data-bs-toggle="popover" title="UDP Output" data-bs-content="Enable this to stream decoded audio over UDP. Useful for network-based audio piping."></i>
              </label>
              <input data-field="udp_output_port" data-section="op25"  type="number" id="udp_output_port" class="form-control form-control-sm" >
            </div>
            <div class="col-md-6">
              <input data-field="override_audio" data-section="op25" data-relative="audio_output" type="checkbox" id="device_override" class="form-check-input">
              <label class="form-label">
                Audio Output Device
                <i class="fas fa-info-circle txt-white ms-1" data-bs-toggle="popover" title="Audio Output Device" data-bs-content="Specify the ALSA device string for audio output (e.g., hw:1,0)."></i>
              </label>
              <input data-field="audio_ouput" data-section="op25" type="text" id="audio_output"  class="form-control form-control-sm">
            </div>
        </div>

          <h4 class="mt-4 mb-4"><i class="fa fa-code me-2"></i>Logging</h4>
          <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">
                  Log Level
                  <i class="fas fa-info-circle txt-white text-muted ms-1" data-bs-toggle="popover" title="Log Level" data-bs-content="Controls how much debug/log information is printed. 0 = silent, 3 = most verbose."></i>
                </label>
                <select id="verbosity" data-field="verbosity" data-section="op25" class="form-select form-select-sm" >
                  <option value="0">0 - Silent</option>
                  <option value="1">1 - Info</option>
                  <option value="2">2 - Debug</option>
                  <option value="3">3 - Trace</option>
                </select>
                </div>
                <div class="col-md-5"> 
                  <label class="form-label">
                    Voice Logging
                    <i class="fas fa-info-circle txt-white ms-1" data-bs-toggle="popover" title="Voice Logging" data-bs-content="Enable this to save decoded audio streams to disk for later review."></i>
                  </label><br/>
                      <input type="checkbox" data-field="voice_logging" data-section="op25" id="voice_logging" class="form-check-input">  
                </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">
                  Stderr Log File
                  <i class="fas fa-info-circle txt-white text-muted ms-1" data-bs-toggle="popover" title="Stderr Log File" data-bs-content="Path where the stderr output of OP25 should be saved."></i>
                </label>
                <input type="text" data-field="stderr_file" data-section="paths" class="form-control-sm form-control" id="stderr_file" >
              </div>
              <div class="col-md-4">
                <label class="form-label">
                  Stdout Log File
                  <i class="fas fa-info-circle txt-white ms-1" data-bs-toggle="popover" title="Stdout Log File" data-bs-content="Path where the stdout output of OP25 should be saved."></i>
                </label>
                <input data-field="stdout_file" data-section="paths"  type="text" class="form-control-sm form-control" id="stdout_file" >
              </div>
              <div class="col-md-4">
                <label class="form-label">
                  App Log File
                  <i class="fas fa-info-circle txt-white ms-1" data-bs-toggle="popover" title="App Log File" data-bs-content="Path for saving log entries from the frontend/backend components."></i>
                </label>
                <input data-field="app_log" data-section="paths" type="text"  class="form-control-sm form-control" id="app_log" >
              </div>
            </div>
        
        <h3 class="mt-4 mb-4"><i class="fa fa-code me-2"></i>Additional Settings</h3>
        <div class="row mb-3">
          <div class="col-md-4 ms-3 mt-1 form-check">
            <input type="checkbox" id="nocrypt" class="form-check-input" >
            <label class="form-check-label" for="nocrypt">
              Mute Encryption
            </label>
              <i class="fas fa-info-circle txt-white ms-1" data-field="nocrypt" data-section="op25" 
              data-bs-toggle="popover" title="NoCrypt" data-bs-content="Skips encrypted talkgroups instead of printing gibberish or static. Should usually be enabled."></i>
          
          </div>
          <div class="col-md-4 ms-3 mt-1 form-check">
            <input type="checkbox" data-field="two_tuner_mode" data-section="op25" id="two_tuner_mode" class="form-check-input" >
            <label class="form-check-label" for="two_tuner_mode">
              Two Tuner Mode
            </label>
            <i class="fas fa-info-circle txt-white ms-1" data-bs-toggle="popover" title="Two Tuner Mode" data-bs-content="Uses one tuner for control channel and another for voice traffic. Improves performance."></i>
          </div>
        </div>
        <button type="button" disabled class="btn btn-primary">Save</button>
      </form>
    
 
  <script>

    document.addEventListener("DOMContentLoaded", function () {
      const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
      popoverTriggerList.forEach(el => {
        new bootstrap.Popover(el);
      });
    });

    document.addEventListener("DOMContentLoaded", async () => {
      await sendGetSleepSettings()
      const relCheckboxes = document.querySelectorAll("[data-relative]");
    
      relCheckboxes.forEach(checkbox => {
        const targetId = checkbox.getAttribute("data-relative");
        const targetInput = document.getElementById(targetId);
    
        function toggleRelatedInput() {
          if (targetInput) {
            targetInput.disabled = !checkbox.checked;
          }
        }
    
        // Do NOT toggle yet — wait for config to load
        checkbox.addEventListener("change", toggleRelatedInput);
      });
    
      sendGetConfig(); // make sure this sets checkbox.checked and triggers .dispatchEvent
    });

    function collectFormData() {
      const config = {};
      const inputs = document.querySelectorAll('[data-section][data-field]');
  
      inputs.forEach(input => {
          const section = input.getAttribute("data-section");
          const field = input.getAttribute("data-field");
  
          if (!config[section]) config[section] = {};
  
          let value;
          if (input.type === "checkbox") {
              value = input.checked ? "true" : "false";
          } else {
              value = input.value;
          }
  
          config[section][field] = value;
      });
  
      return config;
  }
  
  async function returnConfigByPost() {
      const config = collectFormData();
      const response = await fetch(`http://${localhost}:5001/admin/config/set`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(config)
      });
  
      if (response.ok) {
          alert("Configuration saved");
      } else {
          alert("Failed to save configuration");
      }
  }

    const configData = {};  // Holds the config JSON in memory

  // Fetch the config from the backend
  const localhost = location.hostname;

async function sendGetConfig() {
    const response = await fetch(`http://${localhost}:5001/admin/config/get`);
    if (!response.ok) {
        console.error("Failed to fetch config");
        return;
    }

    const config = await response.json();
    populateForm(config);
}

async function sendGetSleepSettings() {
  const response = await fetch(`http://${localhost}:5001/admin/config/device/sleep`);
  if (!response.ok) {
      console.error("Failed to fetch config");
      return;
  }

  const config = await response.json();
  sleepField = document.getElementById("display_sleep");
  sleepField.value = config["timeout"];
}

function populateForm(config) {
    const inputs = document.querySelectorAll('[data-section][data-field]');
    inputs.forEach(input => {
        const section = input.getAttribute("data-section");
        const field = input.getAttribute("data-field");

        if (config[section] && field in config[section]) {
            const value = config[section][field];

            if (input.type === "checkbox") {
                input.checked = value === "true" || value === true;
            } else {
                input.value = value;
            }
        }
    });
}

  // Get a value from the config
  function getConfig(section, key, fallback = null) {
      if (configData[section] && key in configData[section]) {
          return configData[section][key];
      }
      return fallback;
  }

  // Set a value in the config
  function setConfig(section, key, value) {
      if (!configData[section]) {
          configData[section] = {};
      }
      configData[section][key] = value;
  }

  function collectFormData() {
    const config = {};
    const inputs = document.querySelectorAll('[data-section][data-field]');

    inputs.forEach(input => {
        const section = input.getAttribute("data-section");
        const field = input.getAttribute("data-field");

        if (!config[section]) config[section] = {};

        let value;
        if (input.type === "checkbox") {
            value = input.checked ? "true" : "false";
        } else {
            value = input.value;
        }

        config[section][field] = value;
    });

    return config;
}


  </script>
  

</div>
</div>
<script src="../static/bootstrap/js/bootstrap.bundle.min.js"></script>

</body>